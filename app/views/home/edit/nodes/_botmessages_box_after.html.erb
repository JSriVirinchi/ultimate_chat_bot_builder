<!-- declaring ids -->
<% @node = Node.where(bot_id: @bot.id, parent_id: parent_id).first%>

<%if @node%> 
<% botresponses_box_after = "botresponses_box_after_" + (@node.id).to_s %>
<% botmessages_previous = "botmessages_previous_" + (@node.id).to_s %>
<% botresponses_messages_area_text_area = "botresponses_messages_area_text_area_" + (@node.id).to_s%>
<% add_a_node = "add_a_node_" + (@node.id).to_s%>
<% link_to_node = "link_to_node_" + (@node.id).to_s%>
<% link_to_node_label = "link_to_node_label_" + (@node.id).to_s%>
<% transfer_to_agent = "transfer_to_agent_" + (@node.id).to_s%>
<% exit_bot = "exit_bot_" + (@node.id).to_s%>
<% link_to_node_message = "link_to_node_message_" + (@node.id).to_s%>
<% transfer_to_agent_message = "transfer_to_agent_message_" + (@node.id).to_s%>
<% exit_message = "exit_message_" + (@node.id).to_s%>
<% dropdownMenuLink_transfer = "dropdownMenuLink_transfer_" + (@node.id).to_s%>
<% dropdownMenuLink_link_to_node = "dropdownMenuLink_link_to_node_" + (@node.id).to_s%>
<% botmessage_name_edit_name = "botmessage_name_edit_name_" + (@node.id).to_s %>
<% botmessage_name_edit_form = "botmessage_name_edit_form_" + (@node.id).to_s %>
<% infoicon_for_link_to_node = "infoicon_for_link_to_node_" + (@node.id).to_s %>
<% attach_message_image = "attach_message_image_" + (@node.id).to_s%>
<% nodes_message_attach_media_form = "nodes_message_attach_media_form_" + (@node.id).to_s%>
<% submit_button_for_attaching_image = "submit_button_for_attaching_image_" + (@node.id).to_s %>
<% attaching_media_error_messages = "attaching_media_error_messages_" +  (@node.id).to_s%>
<% previous_message_and_options_card_divider = "previous_message_and_options_card_divider_" +  (@node.id).to_s %>
<% text_area_form_hide_or_show = "text_area_form_hide_or_show_" +  (@node.id).to_s %>
<% add_a_new_text_message_button = 'add_a_new_text_message_button_' +  (@node.id).to_s%>
<%end%>

<!-- content -->
<div class="botresponses_box_after hide mb-4" id="<%= botresponses_box_after %>">
	<div class="row">
		<div class="col-10 row mb-2">
			<div class="col-2 mr-2">
				<%= image_tag('chatbot.JPG', size: "25", class: "rounded-circle ml-2 mt-2")%>
			</div>
			<%if @node%>
				<div class="botresponses_text col-9" id= <%= botmessage_name_edit_name%>>
					<%= render 'home/edit/nodes/botmessages_name_field', node: @node, edit_tag: true%>
				</div>
				<div class="col-9 mt-2 hide" id= <%= botmessage_name_edit_form %> >
					<%= form_with scope: :name_edit, url: botmessage_name_update_path(@node.id), method: :put, remote: true do |f|%>					
						<%if @node.name %>
							<%= f.text_field :name, value: @node.name ,class: "form__input_two", style: "width: 85px;"%>
						<% else %>	
							<%= f.text_field :name, class: "form__input_two", placeholder: "Bot Response", style: "width: 85px;"%>
						<% end %>						
						<%= f.submit "Update", class: "btn btn-sm btn-outline-secondary"%>
					<% end %>				
				</div>
			<%end%>
		</div>
		<div class="col-2 text-center">
			<% if Node.where(bot_id: @bot.id, parent_id: parent_id).first%>
			<%= link_to image_tag('dustbin.png', size: "15", class: "mt-2 ml-3 mr-2"), nodes_destroy_path(@node.id), method: :delete , remote: true, data: { confirm: "Are you sure that you want to delete this node? This will delete all the children nodes attached to it. You can edit the current node, if you wanted to."}%>
			<% end %>
		</div>
	</div>

	<div class="card_divider mb-2"></div>

	<!-- added messages -->
	<div id="<%= botmessages_previous%>">
		<%= render 'home/edit/nodes/botmessages_previous', delete_button: true, parent_id: parent_id %>
	</div>
	<!-- text area -->
	
	<div class="text-center mx-auto hide" id= <%= text_area_form_hide_or_show%>>
	<%= form_with scope: :message, url: nodes_message_create_path, method: :post,  remote: true do |f| %>
		<div class="text-center botresponses_messages_area_full">
			<%= text_area(:message, :text_messages, cols: 30, rows: 4, class: 'botresponses_messages_area', value: "", id: botresponses_messages_area_text_area, remote: true)%>
			<%= f.text_field :node_type, value: "bot", class: "hide"%>
			<%= f.text_field :bot_id, value: @bot.id , class: "hide"%>
			<%= f.text_field :message_type, value: "text" , class: "hide"%>
			<% if Node.where(bot_id: @bot.id, parent_id: parent_id).first%>
			<%= f.text_field :node_id, value: @node.id, class: "hide"%>
			<% end %>
			<div class="card_divider_two ml-2 mt-2 mb-1"></div>
			<div class="row mb-1 ml-2">
				<div class="col-4 mt-2">
					<%= link_to image_tag('boldicon.png', size: "12", class: ""), root_path %>
					<%= link_to image_tag('italics.jpg', size: "12", class: "ml-1"), root_path %>
					<%= link_to image_tag('underline.png', size: "15", class: "ml-1"), root_path %>
				</div>
				<div class="col-8" style="text-align: right;">
					<%= f.submit "Add", value: "Add", class: "btn btn-outline-secondary btn-sm mr-4", style: "height: 30px; margin-top: 5px; text-align: right;"%>
				</div>
			</div>
		</div>
	<% end %>	
	</div>
	
	<div class="card_divider mt-3 mb-2 ml-3" style="width: 270px;" id= <%= previous_message_and_options_card_divider%>>
		
	</div>

	<!-- options -->
	
	<div class="row">
		<div class="options_text ml-3 mb-2 mt-1 col-4">
			Add Message
		</div>
		<div class="ml-2 ">
			<% if Node.where(bot_id: @bot.id, parent_id: parent_id).first%>
				<%= link_to image_tag('addbutton.JPG', size: "25", class: "ml-1", id: add_a_new_text_message_button), add_a_new_text_message_button_path(@node.id),remote: true%>
			<%end%>
		</div>
		<div id= <%= attaching_media_error_messages%>>
			<%= render 'layouts/attach_messages'%>	
		</div>
	</div>
	
	<div class="row mt-2 mb-2">
		<div class="options_text ml-3 mb-2 mt-1 col-4">
			Attach Media
		</div>		
		<div class="row" style="margin-left: -7px;">
			<!-- for image -->
			<div class="col-3">
				<%= form_with scope: :attach_message, url: nodes_message_attach_media_path, method: :post, id: nodes_message_attach_media_form , remote: true do |f| %>
				<%= f.text_field :node_type, value: "bot", class: "hide"%>
				<%= f.text_field :bot_id, value: @bot.id , class: "hide"%>
				<%= f.text_field :message_type, value: "image" , class: "hide"%>
				<% if Node.where(bot_id: @bot.id, parent_id: parent_id).first%>
				<%= f.text_field :node_id, value: @node.id, class: "hide"%>
				<% end %>

				<label for="<%= attach_message_image%>">
					<%= image_tag('photoicon.JPG', size: "25", class: "ml-1", style: "cursor: pointer;") %>
				</label>			
				<%= f.file_field :image, id: attach_message_image, class: "hide", onchange: "image_upload();"%>
				
				<%= f.submit "Add", value: "Add", class: "hide", id: submit_button_for_attaching_image %>
				<%end%>
			</div>
			<!-- for video -->
			<div class="col-3">
				<%= link_to image_tag('videoicon.JPG', size: "25", class: "ml-1"), root_path %>
			</div>
			<!-- for pdf -->
			<div class="col-3">
				<%= link_to image_tag('pdficon.JPG', size: "25", class: "ml-1"), root_path %>	
			</div>
			
		</div>
		
	</div>	

	<div class="row mb-2">
		<div class="options_text ml-3 mb-2 mt-1 col-5">
			Advanced Settings
		</div>
		<div class="">
			<%= link_to image_tag('downarrow.png', size: "10", class: ""), root_path %>
		</div>
	</div>
	

	<!-- set next action divider-->
	<div class="row">
		<div class="col-5 options_text_lite text-center ml-1 mt-2 mb-2">
			Set next Action
		</div>
		<div class="card_divider_three col-6 mt-3 mb-2"></div>
	</div>

	<!-- set next action -->
	<% if Node.where(bot_id: @bot.id, parent_id: parent_id).first%>
	<%= form_with scope: :set_next_action, url: nodes_update_options_path(@bot.id, @node.id), method: :put,  remote: true do |f| %>
		<!-- add a node -->
		<div class="mt-1 ml-4">
			<%= f.radio_button :set_next_action , "add_a_node", id: add_a_node%>
			<%= f.label :set_next_action , "Add a node", value: "add_a_node" , class: "ml-2 options_text_bold"%>
		</div>

		<!-- transfer to agent -->
		<div class="mt-1 ml-4">
			<%= f.radio_button :set_next_action , "transfer_to_agent", id: transfer_to_agent%>
			<%= f.label :set_next_action , "Transfer to an agent", value: "transfer_to_agent" , class: "ml-2 options_text_bold"%>
		</div>
		<div class="mb-2 text-center hide" id="<%= transfer_to_agent_message %>">			
			<div class="dropdown show mb-2 ml-3">
			  <a class="btn btn-outline-secondary btn-sm dropdown-toggle" href="#" role="button" id="<%= dropdownMenuLink_transfer%>" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false", style="width: 210px; background-color: transparent; color: black;">
			    Select Transfering group
			  </a>

			  <div class="dropdown-menu" aria-labelledby="<%= dropdownMenuLink_transfer%>", style="width: 210px; background-color: rgb(235,253,221);">
			    <a class="dropdown-item" href="#">Group-1</a>
			    <a class="dropdown-item" href="#">Group-2</a>
			    <a class="dropdown-item" href="#">Group-3</a>
			  </div>
			</div>
			<div class="ml-3">
				<% if @node.transfer_to_agent_message%>
					<%= text_area(:set_next_action, :transfer_to_agent_message, cols: 30, rows: 3, class: 'botresponses_exit_area p-2', value: @node.transfer_to_agent_message)%>
				<% else %>
					<%= text_area(:set_next_action, :transfer_to_agent_message, cols: 30, rows: 3, class: 'botresponses_exit_area p-2', value: "Thank you. Now, you will be transferred to our agent.")%>
				<% end %>
			</div>
		</div>
		<!-- link to node -->
		<div class="mt-1 ml-4">
			<%= f.radio_button :set_next_action , "link_to_node", id: link_to_node%>
			<%= f.label :set_next_action , "Link to another node", value: "link_to_node" , class: "ml-2 options_text_bold", id: link_to_node_label%>
			
			<span class="tooltip-toggle-info hide" aria-label= "As this is the first node in the flow, one cannot link it with previous nodes" style="margin-left: -40px;" id= <%= infoicon_for_link_to_node%>>
				<%= image_tag('infoicon.png', size: "16", class: " ")%>
			</span>
		</div>
		<div class="mb-2 text-center hide" id="<%= link_to_node_message %>">			
			<div class="dropdown show mb-2 ml-3">
			  <a class="btn btn-outline-secondary btn-sm dropdown-toggle" href="#" role="button" id="<%= dropdownMenuLink_link_to_node%>" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false", style="width: 210px; background-color: transparent; color: black;">
			    Link to node
			  </a>

			  <div class="dropdown-menu" aria-labelledby="<%= dropdownMenuLink_transfer%>", style="width: 210px; background-color: rgb(235,253,221);">
			    <% node_name_tag = 0%>
			  	<% for node in Node.where(bot_id: @bot.id, node_type: "bot")%>
			  		<%if node.name != nil && node.name != @node.name%>	
			  			<a href="" class="dropdown-item"><%= truncate(node.name, length: 30)%></a>	
			  			<% node_name_tag = node_name_tag + 1%>
			  		<%end%>	
			    <%end%>			
			    <% if node_name_tag == 0%>
			    	<div class="text-center" style="color: red; font-size: 10px;">
			    		Please name the node to select here
			    	</div>
			    <% end %>	
			  </div>

			</div>
			<div class="ml-3">
				<% if @node.link_to_node_message%>
					<%= text_area(:set_next_action, :link_to_node_message, cols: 30, rows: 3, class: 'botresponses_exit_area p-2', value: @node.link_to_node_message)%>
				<% else %>
					<%= text_area(:set_next_action, :link_to_node_message, cols: 30, rows: 3, class: 'botresponses_exit_area p-2', value: "Ok. Lets start from the beginning")%>
				<% end %>
			</div>
					
		</div>

		<!-- exit bot -->
		<div class="mt-1 ml-4 mb-2">
			<%= f.radio_button :set_next_action , "exit_bot", id: exit_bot , checked: "checked"%>
			<%= f.label :set_next_action , "Exit Conversation", value: "exit_bot" , class: "ml-2 options_text_bold"%>
		</div>
		<div class="mb-2 text-center ml-2" id="<%= exit_message %>">
			<% if @node.exit_message%>
			<%= text_area(:set_next_action, :exit_bot_message, cols: 30, rows: 3, class: 'botresponses_exit_area p-2', value: @node.exit_message)%>
			<% else %>
			<%= text_area(:set_next_action, :exit_bot_message, cols: 30, rows: 3, class: 'botresponses_exit_area p-2', value: "Thank you. Its a great pleasure to have a conversation with you. ")%>
			<% end %>
		</div>

		<div class="mb-2">
			<%= f.submit "Save",value: "Save", class: "btn btn-outline-secondary ml-3 mb-3", style: "width: 270px;"%>
		</div>
	<% end %>
	<% end %>
</div>


<script type="text/javascript">
	function image_upload(){
		console.log('uploaded');
		document.getElementById('<%= submit_button_for_attaching_image%>').click();
	}


	<% if Node.where(bot_id: @bot.id, parent_id: parent_id).first%>
		<%if @node.messages.first == nil%>
			document.getElementById('<%= previous_message_and_options_card_divider%>').classList.add('hide');
			document.getElementById('<%= text_area_form_hide_or_show %>').classList.remove('hide');
		<%else%>
			document.getElementById('<%= previous_message_and_options_card_divider%>').classList.remove('hide');
			document.getElementById('<%= text_area_form_hide_or_show %>').classList.add('hide');	
		<%end%>
		
		<%if parent_id == 0%>
			document.getElementById("<%= link_to_node %>").disabled= "disabled";
			document.getElementById("<%= link_to_node_label %>").style.color = "grey";
			document.getElementById("<%= infoicon_for_link_to_node %>").classList.remove('hide');
		<%end%>
		<% if @node.set_next_action == "add_a_node"%>
			document.getElementById("<%= add_a_node %>").checked = true;
			document.getElementById("<%= transfer_to_agent %>").checked = false;
			document.getElementById("<%= link_to_node %>").checked = false;
			document.getElementById("<%= exit_bot %>").checked = false;
			document.getElementById('<%= exit_message %>').classList.add('hide');
			document.getElementById('<%= transfer_to_agent_message %>').classList.add('hide');
			document.getElementById('<%= link_to_node_message %>').classList.add('hide');
		<% elsif @node.set_next_action == "transfer_to_agent"%>
			document.getElementById("<%= add_a_node %>").checked = false;
			document.getElementById("<%= transfer_to_agent %>").checked = true;
			document.getElementById("<%= link_to_node %>").checked = false;
			document.getElementById("<%= exit_bot %>").checked = false;
			document.getElementById('<%= exit_message %>').classList.add('hide');
			document.getElementById('<%= transfer_to_agent_message %>').classList.remove('hide');
			document.getElementById('<%= link_to_node_message %>').classList.add('hide');
		<% elsif @node.set_next_action == "link_to_node"%>
			document.getElementById("<%= add_a_node %>").checked = false;
			document.getElementById("<%= transfer_to_agent %>").checked = false;
			document.getElementById("<%= link_to_node %>").checked = true;
			document.getElementById("<%= exit_bot %>").checked = false;
			document.getElementById('<%= exit_message %>').classList.add('hide');
			document.getElementById('<%= transfer_to_agent_message %>').classList.add('hide');
			document.getElementById('<%= link_to_node_message %>').classList.remove('hide');	
		<% elsif @node.set_next_action == "exit_bot"%>
			document.getElementById("<%= add_a_node %>").checked = false;
			document.getElementById("<%= transfer_to_agent %>").checked = false;
			document.getElementById("<%= link_to_node %>").checked = false;
			document.getElementById("<%= exit_bot %>").checked = true;
			document.getElementById('<%= exit_message %>').classList.remove('hide');
			document.getElementById('<%= transfer_to_agent_message %>').classList.add('hide');
			document.getElementById('<%= link_to_node_message %>').classList.add('hide');
		<% end %>

		 document.getElementById('<%= exit_bot %>').onclick = function() {
		 	document.getElementById('<%= exit_message %>').classList.remove('hide');
		 	document.getElementById('<%= transfer_to_agent_message %>').classList.add('hide');
		 	document.getElementById('<%= link_to_node_message %>').classList.add('hide');
		 }
		 document.getElementById('<%= add_a_node %>').onclick = function() {
		 	document.getElementById('<%= exit_message %>').classList.add('hide');
		 	document.getElementById('<%= transfer_to_agent_message %>').classList.add('hide');
		 	document.getElementById('<%= link_to_node_message %>').classList.add('hide');
		 }
		 document.getElementById('<%= transfer_to_agent %>').onclick = function() {
		 	document.getElementById('<%= exit_message %>').classList.add('hide');
		 	document.getElementById('<%= transfer_to_agent_message %>').classList.remove('hide');
		 	document.getElementById('<%= link_to_node_message %>').classList.add('hide');
		 }
		 document.getElementById('<%= link_to_node %>').onclick = function() {
		 	document.getElementById('<%= exit_message %>').classList.add('hide');
		 	document.getElementById('<%= transfer_to_agent_message %>').classList.add('hide');
		 	document.getElementById('<%= link_to_node_message %>').classList.remove('hide');
		 }
	 <% end %>
</script>