<% @error_node = Node.where(bot_id: @bot.id, parent_id: @node.id, node_type: "error").first %>
<% if message != "default"%>
	<% message_id = message.id%>
<%else%>
	<% message_id = "default"%>
<%end%>	

<!-- form for each error - variables-->
<% error_message = "error_message_" + (@error_node.id).to_s + "_"+(message_id).to_s%>			
<% transfer_to_agent = "transfer_to_agent_" + (@error_node.id).to_s + "_"+(message_id).to_s%>			
<% link_to_node = "link_to_node_" + (@error_node.id).to_s + "_"+(message_id).to_s%>			
<% exit_message = "exit_message_" + (@error_node.id).to_s + "_"+(message_id).to_s %>

<% error_message_text_area = "error_message_text_area_" + (@error_node.id).to_s + "_"+(message_id).to_s%>
<% transfer_to_agent_text_and_dropdown = "transfer_to_agent_text_and_dropdown_" + (@error_node.id).to_s + "_"+(message_id).to_s %>
<% link_to_node_text_and_dropdown = "link_to_node_text_and_dropdown" + (@error_node.id).to_s + "_"+(message_id).to_s%>
<% exit_message_text_area = "exit_message_text_area" + (@error_node.id).to_s + "_"+(message_id).to_s %>
<% transfer_to_agent_text_and_dropdown_id = "transfer_to_agent_text_and_dropdown_id_" + (@error_node.id).to_s + "_"+(message_id).to_s%>
<% link_to_node_text_and_dropdown_id = "link_to_node_text_and_dropdown_id_" + (@error_node.id).to_s + "_"+(message_id).to_s %>

<!-- for for each error - actual form -->

<%= form_with scope: :error_node, url: error_node_message_save_path(@error_node.id, message_id), method: :post, id: "form", remote: true do |f| %>
<!-- error message -->
	<div class="mt-1">
		<%= f.radio_button :error_node , "error_message", id: error_message, checked: "checked"%>
		<%= f.label :error_node , "Send error message", value: "error_message" , class: "ml-2 error_message_text"%>
	</div>
	<div class="ml-3 mt-2 mb-2" id= <%= error_message_text_area%>>
		<%if message != "default" && message.error_node_message%> 
			<%= text_area(:error_node, :error_node_message, cols: 28, rows: 2, class: ' error_node_message_text_area error_node_message_text_area_text', value: message.error_node_message)%>
		<%else%>
			<%= text_area(:error_node, :error_node_message, cols: 28, rows: 2, class: ' error_node_message_text_area error_node_message_text_area_text', value: "I did not understand what you have said. Please rephrase it.")%>
		<%end%>
	</div>
<!-- transfer to agent -->
	<div class="mt-1">
		<%= f.radio_button :error_node , "transfer_to_agent", id: transfer_to_agent %>
		<%= f.label :error_node , "Transfer to an agent", value: "transfer_to_agent" , class: "ml-2 error_message_text"%>
	</div>
	<div class="hide" id= <%= transfer_to_agent_text_and_dropdown%>>
		<div class="dropdown show mb-2 ml-3">
		  <a class="btn btn-outline-secondary btn-sm dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false", style="width: 215px; background-color: transparent; color: grey; border-color: grey;" id= <%= transfer_to_agent_text_and_dropdown_id%>>
		    Transfer to group
		  </a>
		  <div class="dropdown-menu" aria-labelledby=<%= transfer_to_agent_text_and_dropdown_id%>, style="width: 215px;">					  	
		  	<a class="dropdown-item" href= <%= root_path %> >Group -1</a>
		  	<a class="dropdown-item" href= <%= root_path %> >Group -2</a>
		  	<a class="dropdown-item" href= <%= root_path %> >Group -3</a>					    			    
		  </div>
		</div>
		<div class="ml-3 mt-2 mb-2">
			<%if message != "default" && message.error_node_transfer_to_agent_message%> 
				<%= text_area(:error_node, :error_node_transfer_to_agent_message, cols: 28, rows: 2, class: ' error_node_message_text_area error_node_message_text_area_text', value: message.error_node_transfer_to_agent_message)%>
			<%else%>
				<%= text_area(:error_node, :error_node_transfer_to_agent_message, cols: 28, rows: 2, class: ' error_node_message_text_area error_node_message_text_area_text', value: "Transferring to an agent group")%>
			<%end%>	
		</div>
	</div>
<!-- link to node -->
	<div class="mt-1">
		<%= f.radio_button :error_node , "link_to_node", id: link_to_node %>
		<%= f.label :error_node , "Link to another node", value: "link_to_node" , class: "ml-2 error_message_text"%>
	</div>
	<div class="hide" id= <%= link_to_node_text_and_dropdown%>>
		<div class="dropdown show mb-2 ml-3">
		  <a class="btn btn-outline-secondary btn-sm dropdown-toggle" href="#" role="button" id= <%= link_to_node_text_and_dropdown_id %>, data-toggle="dropdown" aria-haspopup="true" aria-expanded="false", style="width: 215px; background-color: transparent; color: grey; border-color: grey;">
		    <span>Select Node</span>
		  </a>
		  <div class="dropdown-menu" aria-labelledby=<%= link_to_node_text_and_dropdown_id %>, style="width: 215px;">
		  	<% node_name_tag = 0%>
		  	<% for node in Node.where(bot_id: @bot.id, node_type: "bot")%>
		  		<%if node.name != nil%>	
		  			<a href="" class="dropdown-item"><%= truncate(node.name, length: 30)%></a>	
		  			<% node_name_tag = node_name_tag + 1%>
		  		<%end%>	
		    <%end%>			
		    <% if node_name_tag == 0%>
		    	<div class="text-center" style="color: red; font-size: 10px;">
		    		Please name the node to select here
		    	</div>
		    <% end %>	    
		  </div>
		</div>
		<div class="ml-3 mt-2 mb-2">
			<%if message != "default" && message.error_node_link_to_message%>
				<%= text_area(:error_node, :error_node_link_to_message, cols: 28, rows: 2, class: ' error_node_message_text_area error_node_message_text_area_text', value: message.error_node_link_to_message)%>
			<%else%>
				<%= text_area(:error_node, :error_node_link_to_message, cols: 28, rows: 2, class: ' error_node_message_text_area error_node_message_text_area_text', value: "Ok. Lets start from the beginning")%>
			<%end%>	
		</div>
	</div>
<!-- exit message -->
	<div class="mt-1">
		<%= f.radio_button :error_node , "exit_message", id: exit_message %>
		<%= f.label :error_node , "Exit conversation", value: "exit_message" , class: "ml-2 error_message_text"%>
	</div>
	<div class="ml-3 mt-2 mb-2 hide" id= <%= exit_message_text_area%>>
		<%if message != "default" && message.error_node_exit_message%>
			<%= text_area(:error_node, :error_node_exit_message, cols: 28, rows: 2, class: ' error_node_message_text_area error_node_message_text_area_text', value: message.error_node_exit_message)%>
		<%else%>
			<%= text_area(:error_node, :error_node_exit_message, cols: 28, rows: 2, class: ' error_node_message_text_area error_node_message_text_area_text', value: "Sorry, I did not get what you said. Exiting the conversation.")%>
		<%end%>	
	</div>

	<div class="text-center">
		<%if message == "default"%>
			<%= f.submit "Save the error attempt", class: "btn btn-sm btn-outline-secondary mt-2", style: "color: grey; width: 180px;"%>
		<%else%>
			<%= f.submit "Update the error attempt", class: "btn btn-sm btn-outline-secondary mt-2", style: "color: grey; width: 180px;"%>
		<%end%>
	</div>
<!-- end of actual form -->
<% end %>

<script type="text/javascript">

	<%if message != "default"%>
	<%if message.error_node == "error_message"%>
		document.getElementById('<%= error_message %>').checked = true;
		document.getElementById('<%= transfer_to_agent %>').checked = false;
		document.getElementById('<%= link_to_node %>').checked = false;
		document.getElementById('<%= exit_message%>').checked = false;

		document.getElementById('<%= error_message_text_area%>').classList.remove('hide');
		document.getElementById('<%= transfer_to_agent_text_and_dropdown%>').classList.add('hide');
		document.getElementById('<%= link_to_node_text_and_dropdown%>').classList.add('hide');			
		document.getElementById('<%= exit_message_text_area%>').classList.add('hide');
	<%elsif message.error_node == "transfer_to_agent"%>
		document.getElementById('<%= error_message %>').checked = false;
		document.getElementById('<%= transfer_to_agent %>').checked = true;
		document.getElementById('<%= link_to_node %>').checked = false;
		document.getElementById('<%= exit_message%>').checked = false;

		document.getElementById('<%= error_message_text_area%>').classList.add('hide');
		document.getElementById('<%= transfer_to_agent_text_and_dropdown%>').classList.remove('hide');			
		document.getElementById('<%= link_to_node_text_and_dropdown%>').classList.add('hide');			
		document.getElementById('<%= exit_message_text_area%>').classList.add('hide');
	<%elsif message.error_node == "link_to_node"%>
		document.getElementById('<%= error_message %>').checked = false;
		document.getElementById('<%= transfer_to_agent %>').checked = false;
		document.getElementById('<%= link_to_node %>').checked = true;
		document.getElementById('<%= exit_message%>').checked = false;

		document.getElementById('<%= error_message_text_area%>').classList.add('hide');
		document.getElementById('<%= transfer_to_agent_text_and_dropdown%>').classList.add('hide');
		document.getElementById('<%= link_to_node_text_and_dropdown%>').classList.remove('hide');			
		document.getElementById('<%= exit_message_text_area%>').classList.add('hide');	
	<%elsif message.error_node == "exit_message"%>
		document.getElementById('<%= error_message %>').checked = false;
		document.getElementById('<%= transfer_to_agent %>').checked = false;
		document.getElementById('<%= link_to_node %>').checked = false;
		document.getElementById('<%= exit_message%>').checked = true;

		document.getElementById('<%= error_message_text_area%>').classList.add('hide');
		document.getElementById('<%= link_to_node_text_and_dropdown%>').classList.add('hide');			
		document.getElementById('<%= transfer_to_agent_text_and_dropdown%>').classList.add('hide');			
		document.getElementById('<%= exit_message_text_area%>').classList.remove('hide');
	<%end%>
	<%end%>

	document.getElementById('<%= error_message %>').onclick = function() {
		document.getElementById('<%= error_message_text_area%>').classList.remove('hide');
		document.getElementById('<%= transfer_to_agent_text_and_dropdown%>').classList.add('hide');			
		document.getElementById('<%= link_to_node_text_and_dropdown%>').classList.add('hide');			
		document.getElementById('<%= exit_message_text_area%>').classList.add('hide');
	}
	document.getElementById('<%= transfer_to_agent %>').onclick = function() {
		document.getElementById('<%= error_message_text_area%>').classList.add('hide');
		document.getElementById('<%= transfer_to_agent_text_and_dropdown%>').classList.remove('hide');			
		document.getElementById('<%= link_to_node_text_and_dropdown%>').classList.add('hide');			
		document.getElementById('<%= exit_message_text_area%>').classList.add('hide');
	}
	document.getElementById('<%= link_to_node %>').onclick = function() {
		document.getElementById('<%= error_message_text_area%>').classList.add('hide');
		document.getElementById('<%= transfer_to_agent_text_and_dropdown%>').classList.add('hide');			
		document.getElementById('<%= link_to_node_text_and_dropdown%>').classList.remove('hide');			
		document.getElementById('<%= exit_message_text_area%>').classList.add('hide');
	}
	document.getElementById('<%= exit_message %>').onclick = function() {
	 	document.getElementById('<%= error_message_text_area%>').classList.add('hide');
		document.getElementById('<%= transfer_to_agent_text_and_dropdown%>').classList.add('hide');			
		document.getElementById('<%= link_to_node_text_and_dropdown%>').classList.add('hide');			
		document.getElementById('<%= exit_message_text_area%>').classList.remove('hide');
	}
</script>